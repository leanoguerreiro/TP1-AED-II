<!doctype html> 
<html lang="pt-BR">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>PopScreen — Recomendações</title>
    <!-- Incluindo a fonte Poppins -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root{
            --bg:#060608;
            --panel: rgba(18,10,24,0.6);
            --accent: #a855f7;
            --accent-2: #6b21a8;
            --muted: #bfa6dd;
            --card-bg: rgba(255,255,255,0.03);
            --glass: rgba(255,255,255,0.04);
            --white: #f8f4ff;
        }
        *{box-sizing:border-box}
        body{
            margin:0;
            font-family: "Poppins", system-ui, -apple-system, "Segoe UI", Roboto, Arial;
            background: linear-gradient(180deg, #070607 0%, #0f0616 50%, #000000 100%);
            color:var(--white);
            -webkit-font-smoothing:antialiased;
            -moz-osx-font-smoothing:grayscale;
        }

        /* HEADER */
        header{
            display:flex;
            justify-content:space-between;
            align-items:center;
            padding:18px 28px;
            background: rgba(6,6,6,0.6);
            border-bottom: 1px solid rgba(168,85,247,0.08);
            position: sticky; top:0; z-index:999;
            backdrop-filter: blur(6px);
        }
        .brand{ font-weight:700; color:var(--accent); font-size:1.25rem }
        .header-right{ display:flex; gap:14px; align-items:center }

        /* SEARCH */
        .search-wrap{ position:relative; display:flex; align-items:center }
        .search-input{
            padding:10px 12px 10px 40px;
            border-radius:10px;
            border: 1px solid rgba(168,85,247,0.18);
            background: #0c0b0f;
            color:var(--white);
            width:320px;
            outline:none;
        }
        .search-input::placeholder{ color: rgba(255,255,255,0.45) }
        .search-icon{
            width:16px;height:16px;border:3px solid var(--accent);border-radius:50%;
            position:absolute; left:12px; top:50%; transform:translateY(-50%);
        }
        .search-icon::after{
            content:""; width:10px; height:3px; background:var(--accent);
            position:absolute; right:-7px; bottom:-3px; transform:rotate(45deg); border-radius:2px;
        }
        .btn{
            padding:10px 14px;border-radius:10px;border:none;background:var(--accent-2);color:white;cursor:pointer;
            font-weight:600;
            transition: background 0.2s;
        }
        .btn:hover{ background:var(--accent) }

        /* PAGE LAYOUT */
        .page {
            max-width:1200px;
            margin:28px auto;
            padding:0 20px 80px;
        }

        h1{ font-size:1.9rem; color:var(--white); margin:18px 0 }
        p.lead{ color:var(--muted); margin:0 0 18px 0 }

        /* TOP PICKS (carrossel) */
        .section{ margin-top:26px }
        .section-title{ display:flex; justify-content:space-between; align-items:center; margin-bottom:12px }
        .section-title h2{ margin:0; color:var(--accent); font-size:1.2rem }
        .row{
            overflow:hidden;
            position:relative;
        }
        .carousel{
            display:flex;
            gap:14px;
            overflow-x:auto;
            padding-bottom:6px;
            scroll-behavior:smooth;
        }
        .carousel::-webkit-scrollbar{ height:10px }
        .carousel::-webkit-scrollbar-thumb{ background: rgba(168,85,247,0.18); border-radius:10px }

        .card{
            min-width:220px;
            width:220px;
            height: 320px;
            background:var(--card-bg);
            border-radius:12px;
            position:relative;
            box-shadow: 0 8px 30px rgba(0,0,0,0.6);
            border:1px solid rgba(168,85,247,0.06);
            overflow:hidden;
            flex:0 0 auto;
            cursor:pointer;
            transition: transform 0.2s;
        }
        .card:hover { transform: scale(1.02); }
        .card img{ width:100%; height:100%; object-fit:cover; display:block }
        .card .meta{
            position:absolute; left:0; right:0; bottom:0;
            padding:12px; background: linear-gradient(180deg, transparent, rgba(0,0,0,0.8));
            color:var(--white);
            font-weight:600;
        }
        .card .meta small{ display:block; color:var(--muted); font-weight:500; margin-top:6px; font-size:0.85rem }

        .empty{
            padding:26px; background:var(--glass); border-radius:12px; color:var(--muted);
        }

        .pills{ display:flex; gap:10px; flex-wrap:wrap; margin-top:12px }
        .pill{
            padding:8px 12px; border-radius:999px; background: rgba(168,85,247,0.08);
            color:var(--white); border:1px solid rgba(168,85,247,0.06); font-weight:600; font-size:0.9rem;
        }
        
        /* Genre Filter Styling */
        #topPicksInfo {
            display: flex;
            align-items: center;
            color:var(--muted); 
            font-size:0.95rem;
        }
        #genre-select {
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid var(--accent);
            background: rgba(12, 11, 15, 0.8);
            color: var(--white);
            outline: none;
            cursor: pointer;
            appearance: none; /* Remove default dropdown arrow */
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="%23bfa6dd" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>');
            background-repeat: no-repeat;
            background-position: right 10px center;
            padding-right: 30px; /* Space for the custom arrow */
        }
        #genre-select:focus {
             border-color: var(--accent-2);
        }

        @media (max-width:900px){
            .search-input{ width:200px }
            .card{ min-width:160px; width:160px; height:240px }
        }

        .poster-placeholder{
            display:flex; align-items:center; justify-content:center; height:100%; color:var(--muted); background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.03));
            font-weight:700; text-align:center; padding:10px;
        }
    </style>
</head>
<body>

<header>
    <div class="brand">PopScreen</div>
    <div class="header-right">
        <div class="search-wrap" role="search" aria-label="Pesquisar filmes">
            <span class="search-icon" aria-hidden="true"></span>
            <input id="search" class="search-input" type="search" placeholder="Procurar filme, ator, gênero...">
        </div>
        <button class="btn" id="btnSearch">Minha lista</button>

        <button class="btn" id="btnCatalogo">Catálogo</button>
    
        <button class="btn" id="btnExit">Voltar</button>
    </div>
</header>

<main class="page" role="main">
    <h1>Recomendações para você</h1>
    <section class="section">
        <div class="section-title">
            <h2>Populares (CSV)</h2>
            <div id="topPicksInfo">
                <select id="genre-select">
                    <option value="Todos">Todos</option>
                </select>
            </div>
        </div>

        <div class="row">
            <div id="popularCarousel" class="carousel"></div>
        </div>
    </section>

    <!-- Em Cartaz: Permanece com TMDB -->
    <section id="nowPlaying" class="section">
        <div class="section-title">
            <h2>Em Cartaz (TMDB)</h2>
            <div style="color:var(--muted); font-size:0.95rem">Via API</div>
        </div>
        <div class="row">
            <div id="nowPlayingCarousel" class="carousel"></div>
        </div>
    </section>

    <!-- Lançamentos: Permanece com TMDB -->
    <section id="upcoming" class="section">
        <div class="section-title">
            <h2>Lançamentos (TMDB)</h2>
            <div style="color:var(--muted); font-size:0.95rem">Via API</div>
        </div>
        <div class="row">
            <div id="upcomingCarousel" class="carousel"></div>
        </div>
    </section>

    <!-- Por Gênero: Permanece com TMDB -->
    <section id="byGenre" class="section"></section>

    <!-- Ação CSV -->
    <section class="section">
        <div class="section-title">
            <h2>Ação (CSV)</h2>
        </div>
        <div class="row">
            <div id="acaoCarousel" class="carousel"></div>
        </div>
    </section>

    <!-- Aventura CSV -->
    <section class="section">
        <div class="section-title">
            <h2>Aventura (CSV)</h2>
        </div>
        <div class="row">
            <div id="aventuraCarousel" class="carousel"></div>
        </div>
    </section>

    <!-- Animação CSV -->
    <section class="section">
        <div class="section-title">
            <h2>Animação (CSV)</h2>
        </div>
        <div class="row">
            <div id="animacaoCarousel" class="carousel"></div>
        </div>
    </section>

    <!-- Comédia CSV -->
    <section class="section">
        <div class="section-title">
            <h2>Comédia (CSV)</h2>
        </div>
        <div class="row">
            <div id="comediaCarousel" class="carousel"></div>
        </div>
    </section>

</main>

<script>
    /* Configurações */
    const TMDB_KEY = "eyJhbGciOiJIUzI1NiJ9.eyJhdWQiOiIyOGY1MDBmNjYyMmE0ZWIwYmVhZjk3OTkwZTcwOWEzZSIsIm5iZiI6MTc2Mzc0NzAyMy45NzEsInN1YiI6IjY5MjBhNGNmNGNiYjY1YTk1NTA1OGU0ZSIsInNjb3BlcyI6WyJhcGlfcmVhZCJdLCJ2ZXJzaW9uIjoxfQ.2m0_5x9WXUM8HzK6stU4dYR8sI_HRz0trb2Z5e97vmA";
    const TMDB_BASE = "https://api.themoviedb.org/3";
    const BACKEND = "http://localhost:5000";

    let tmdbGenreMap = {};

    /* Utils */
    function createPlaceholderImage(title) {
        const text = (title || "PopScreen").substring(0, 18).replace(/\s/g, '+');
        return `https://placehold.co/220x330/1e0730/a855f7?text=${text}`;
    }

    /* Modal detalhado */
    function showFilmDetail(f) {
        const overlay = document.createElement('div');
        Object.assign(overlay.style, {
            position:'fixed', left:0, top:0, right:0, bottom:0,
            background:'rgba(0,0,0,0.85)', display:'flex',
            alignItems:'center', justifyContent:'center', zIndex:9999, padding:'20px',
            backdropFilter:'blur(4px)'
        });

        const container = document.createElement('div');
        Object.assign(container.style, {
            width:'min(880px,98%)', background:'#0b0b0b', borderRadius:'12px',
            color:'#fff', overflow:'hidden', border:'1px solid rgba(168,85,247,0.25)'
        });

        const genres = (f.genres && f.genres.length) ? f.genres.join(' • ') : '—';
        const nota = f.nota ? (typeof f.nota === 'number' ? f.nota.toFixed(1) : f.nota) : '—';
        const overview = f.overview || 'Sem sinopse disponível.';

        container.innerHTML = `
            <div style="display:flex; gap:18px; padding:24px; align-items:flex-start;">
                <img src="${f.img || createPlaceholderImage(f.titulo)}" style="min-width:220px;width:220px;height:330px;object-fit:cover;border-radius:8px;" onerror="this.src='${createPlaceholderImage(f.titulo)}'">
                <div style="flex:1;">
                    <h2 style="margin:0 0 8px 0; color:var(--accent)">${f.titulo} <small style="color:var(--muted); font-weight:600">(${f.year || '----'})</small></h2>
                    <div style="color:var(--muted); margin-bottom:12px">${genres} • ${(f.language||'').toUpperCase()}</div>
                    <p style="color:var(--white); line-height:1.6; margin-bottom:18px">${overview}</p>
                    <div style="font-weight:700; margin-bottom:14px">Duração: ${f.runtime || '—'}  |  Nota: ${nota}</div>
                    <div>
                        <button id="btnAddLista" style="padding:12px 18px;border-radius:999px;background:var(--accent);color:#fff;border:none;cursor:pointer;font-weight:600">Adicionar à Minha Lista</button>
                        <button id="btnClose" style="margin-left:12px;padding:10px 14px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:var(--muted);cursor:pointer">Fechar</button>
                    </div>
                </div>
            </div>
        `;

        overlay.appendChild(container);
        document.body.appendChild(overlay);

        overlay.addEventListener('click', (e) => { if (e.target === overlay) overlay.remove(); });
        container.querySelector('#btnClose').onclick = () => overlay.remove();
        container.querySelector('#btnAddLista').onclick = () => {
            let lista = JSON.parse(localStorage.getItem('listaFilmes')) || [];
            if (!lista.some(it => it.titulo === f.titulo)) {
                lista.push({
                    id: f.id, titulo: f.titulo, year: f.year, genres: f.genres, img: f.img, overview: f.overview
                });
                localStorage.setItem('listaFilmes', JSON.stringify(lista));
                console.log(`"${f.titulo}" adicionado à lista.`);
            } else {
                console.log(`"${f.titulo}" já está na lista.`);
            }
        };
    }

    /* Permite clicar no card de filmes para ver informações */
    function makeCard(movie) {
        const card = document.createElement('div');
        card.className = 'card';

        const img = document.createElement('img');
        img.src = movie.img || createPlaceholderImage(movie.titulo);
        img.alt = movie.titulo || 'Filme';
        img.onerror = () => { img.src = createPlaceholderImage(movie.titulo); };

        const meta = document.createElement('div');
        meta.className = 'meta';

        const title = document.createElement('strong');
        title.textContent = movie.titulo || '—';

        const small = document.createElement('small');
        const year = movie.year || movie.ano || '----';
        const genresText = Array.isArray(movie.genres) ? movie.genres.join(', ') : (movie.genero || '');
        small.textContent = `${year}${genresText ? ' • ' + genresText : ''}`;

        const rating = document.createElement('div');
        rating.style.marginTop = '6px';
        rating.style.fontWeight = '700';
        rating.textContent = movie.nota ? `⭐ ${movie.nota}` : '';

        meta.appendChild(title);
        meta.appendChild(small);
        meta.appendChild(rating);

        card.appendChild(img);
        card.appendChild(meta);

        card.addEventListener('click', () => {
            showFilmDetail({
                id: movie.id,
                titulo: movie.titulo,
                year: movie.year || movie.ano,
                genres: Array.isArray(movie.genres) ? movie.genres : (movie.genero ? movie.genero.split('|') : []),
                language: movie.language || movie.original_language || 'pt-br',
                img: movie.img,
                overview: movie.overview || movie.description || '',
                nota: movie.nota,
                runtime: movie.runtime || null
            });
        });

        return card;
    }

    /* Auxiliar de busca do TMDB */
    async function tmdbFetch(path, params = {}) {
        const url = new URL(TMDB_BASE + path);
        for (const k in params) url.searchParams.append(k, params[k]);
        try {
            const res = await fetch(url.toString(), {
                headers: { Authorization: `Bearer ${TMDB_KEY}`, Accept:'application/json' }
            });
            if (!res.ok) return null;
            return res.json();
        } catch (e) { console.error('TMDB fetch error', e); return null; }
    }

    /* Renders */
    async function renderList_TMDB(endpoint, elementId, limit=12) {
        const container = document.getElementById(elementId);
        if (!container) return;
        container.innerHTML = '';
        try {
            const resp = await tmdbFetch(endpoint, { language:'pt-BR', page:1 });
            if (!resp || !resp.results) { container.innerHTML = `<div class="empty">Falha ao carregar dados TMDB.</div>`; return; }
            resp.results.slice(0, limit).forEach(r => {
                const m = {
                    id: r.id,
                    titulo: r.title,
                    img: r.poster_path ? `https://image.tmdb.org/t/p/w500${r.poster_path}` : null,
                    year: (r.release_date||'').slice(0,4),
                    genres: (r.genre_ids||[]).map(id => tmdbGenreMap[id]).filter(Boolean),
                    overview: r.overview,
                    language: r.original_language,
                    nota: r.vote_average,
                    runtime: r.runtime
                };
                container.appendChild(makeCard(m));
            });
        } catch (e) { console.error(e); container.innerHTML = `<div class="empty">Erro ao carregar TMDB</div>`; }
    }

    async function renderList_BackendGenero(genero, elementId) {
        const container = document.getElementById(elementId);
        if (!container) return;
        container.innerHTML = '';
        try {
            const resp = await fetch(`${BACKEND}/api/recomendacoes?generos=${encodeURIComponent(genero)}&limit=12`);
            const data = await resp.json();
            data.forEach(f => container.appendChild(makeCard({
                id: f.id || f._id, titulo: f.titulo, img: f.img, year: f.ano, genres: f.genero ? f.genero.split('|') : [], nota: f.nota
            })));
        } catch (e) { console.error('Erro backend genero', e); container.innerHTML = `<div class="empty">Erro ao carregar filmes (${genero})</div>`; }
    }

    async function renderPopulares() {
        const container = document.getElementById('popularCarousel');
        if (!container) return;
        container.innerHTML = '';

        const selectedGenres = JSON.parse(localStorage.getItem('selectedGenres') || '[]');
        let filmes = [];

        // Caso tenha gêneros selecionados
        if (selectedGenres.length > 0) {

            // Atualiza título
            document.querySelector('.page h1').textContent = 'Recomendações Personalizadas';

            // Buscar cada gênero separadamente
            const promises = selectedGenres.map(g =>
                fetch(`${BACKEND}/api/recomendacoes?generos=${encodeURIComponent(g)}&limit=12`)
                    .then(r => r.json())
                    .catch(() => [])
            );

            const resultados = await Promise.all(promises);

            // Juntar e remover duplicados por ID
            const mapa = {};
            resultados.flat().forEach(f => {
                mapa[f.id] = f;
            });

            filmes = Object.values(mapa);

            // Se ainda assim não vier nada
            if (filmes.length === 0) {
                container.innerHTML = `<div class="empty">Nenhum filme encontrado para suas preferências.</div>`;
                return;
            }

        } else {
            // SEM preferência -> usar lista padrão
            document.querySelector('.page h1').textContent = 'Recomendações para você';

            try {
                const resp = await fetch(`${BACKEND}/api/recomendacoes?limit=20`);
                filmes = await resp.json();
            } catch (e) {
                console.error(e);
                container.innerHTML = `<div class="empty">Erro ao carregar recomendações.</div>`;
                return;
            }
        }

        // Renderizar cards
        filmes.slice(0, 20).forEach(f => {
            container.appendChild(makeCard({
                id: f.id,
                titulo: f.titulo,
                img: f.img,
                year: f.ano,
                genres: f.genero ? f.genero.split('|') : [],
                nota: f.nota,
                overview: f.overview || ''
            }));
        });
    }

    async function carregarGeneros() {
        try {
            const resp = await fetch(`${BACKEND}/api/generos`);
            const data = await resp.json();
            const generos = data.generos || data || [];
            const select = document.getElementById('genre-select');
            // remove existing (except Todos)
            Array.from(select.options).forEach(opt => { if (opt.value !== 'Todos') opt.remove(); });
            generos.forEach(g => { const opt = document.createElement('option'); opt.value = g; opt.textContent = g; select.appendChild(opt); });
        } catch (e) { console.warn('erro carregar generos', e); }
    }

    /* busca simultânea CSV (backend) e TMDB */
    const searchInput = document.getElementById('search');
    let searchTimeout = null;

    searchInput.addEventListener('input', () => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(async () => {
            const q = searchInput.value.trim();
            const topInfo = document.getElementById('topPicksInfo');

            if (!q) {
                topInfo.innerHTML = `<label for="genre-select" style="margin-right:8px; white-space:nowrap;">Filtrar por Gênero:</label>
                                    <select id="genre-select"><option value="Todos">Todos</option></select>`;
                await carregarGeneros();
                document.getElementById('genre-select').addEventListener('change', (e) => {
                    const genero = e.target.value;
                    if (genero === 'Todos') renderPopulares(); else renderList_BackendGenero(genero, 'popularCarousel');
                });
                renderPopulares();
                renderList_TMDB('/movie/now_playing', 'nowPlayingCarousel');
                renderList_TMDB('/movie/upcoming', 'upcomingCarousel');
                document.getElementById('byGenre').innerHTML = '';
                return;
            }

            // mostra estado
            topInfo.innerHTML = `<div style="color:var(--muted); font-size:0.95rem">Buscando por "${q}"...</div>`;

            try {
                // duas consultas paralelas
                const backendPromise = fetch(`${BACKEND}/api/filmes/buscar?q=${encodeURIComponent(q)}`).then(r => r.ok ? r.json() : null).catch(()=>null);
                const tmdbPromise = tmdbFetch('/search/movie', { query:q, language:'pt-BR', page:1, include_adult:false });

                const [csvResp, tmdbResp] = await Promise.all([backendPromise, tmdbPromise]);

                const container = document.getElementById('popularCarousel');
                container.innerHTML = '';

                const combined = [];

                // Backend CSV results: app.py returns { filmes: [...] }
                if (csvResp && Array.isArray(csvResp.filmes)) {
                    csvResp.filmes.slice(0, 12).forEach(f => {
                        combined.push({
                            source: 'csv',
                            id: f.id, titulo: f.titulo, img: f.img, year: f.ano, genres: f.genero ? f.genero.split('|') : [], nota: f.nota, overview: f.overview || ''
                        });
                    });
                }

                // TMDB results
                if (tmdbResp && Array.isArray(tmdbResp.results)) {
                    tmdbResp.results.slice(0, 12).forEach(r => {
                        combined.push({
                            source: 'tmdb',
                            id: r.id, titulo: r.title, img: r.poster_path ? `https://image.tmdb.org/t/p/w500${r.poster_path}` : null,
                            year: (r.release_date||'').slice(0,4),
                            genres: (r.genre_ids||[]).map(id => tmdbGenreMap[id]).filter(Boolean),
                            nota: r.vote_average, overview: r.overview, language: r.original_language
                        });
                    });
                }

                if (combined.length === 0) {
                    container.innerHTML = `<div class="empty">Nenhum resultado encontrado para "${q}"</div>`;
                } else {
                    combined.slice(0, 24).forEach(item => container.appendChild(makeCard(item)));
                }

                // limpar outras seções para foco na busca
                document.getElementById('nowPlayingCarousel').innerHTML = '';
                document.getElementById('upcomingCarousel').innerHTML = '';
                document.getElementById('byGenre').innerHTML = '';
                topInfo.innerHTML = `<div style="color:var(--muted); font-size:0.95rem">Resultados da busca</div>`;
            } catch (e) {
                console.error('Erro na busca combinada', e);
                document.getElementById('popularCarousel').innerHTML = `<div class="empty">Erro ao buscar</div>`;
            }
        }, 400);
    });

    /* Inicialização */
    async function init() {
        // pegar mapa de gêneros TMDB
        const genresResp = await tmdbFetch('/genre/movie/list', { language:'pt-BR' }) || {};
        tmdbGenreMap = {};
        (genresResp.genres || []).forEach(g => tmdbGenreMap[g.id] = g.name);

        // carregar generos backend e hook
        await carregarGeneros();
        const sel = document.getElementById('genre-select');
        sel.addEventListener('change', (e) => {
            const genero = e.target.value;
            if (genero === 'Todos') renderPopulares(); else renderList_BackendGenero(genero, 'popularCarousel');
        });

        // render inicial
        renderPopulares();
        renderList_TMDB('/movie/now_playing', 'nowPlayingCarousel');
        renderList_TMDB('/movie/upcoming', 'upcomingCarousel');

        // CSV per-genre carousels
        renderList_BackendGenero('Ação', 'acaoCarousel');
        renderList_BackendGenero('Aventura', 'aventuraCarousel');
        renderList_BackendGenero('Animação', 'animacaoCarousel');
        renderList_BackendGenero('Comédia', 'comediaCarousel');

    }

    init().catch(e => console.error(e));

    /* Botões de cabeçalho */
    document.getElementById("btnSearch").onclick = () => { window.location.href = "lista.html"; };
    document.getElementById("btnCatalogo").onclick = () => { window.location.href = "catalogo.html"; }; 
    document.getElementById("btnExit").onclick = () => { window.location.href = "index.html"; };
</script>

</body>
</html>